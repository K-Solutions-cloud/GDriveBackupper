#!/bin/bash
# ============================================================
# Project Restore Script
# Interactive helper for restoring projects from restic backups
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

if [[ -f "${PROJECT_DIR}/config/backup.env" ]]; then
    source "${PROJECT_DIR}/config/backup.env"
else
    echo "ERROR: Configuration file not found: ${PROJECT_DIR}/config/backup.env"
    exit 1
fi

export RESTIC_REPOSITORY
export RESTIC_PASSWORD_FILE

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

print_header() {
    echo -e "${BOLD}${BLUE}"
    echo "Project Restore Helper"
    echo "======================"
    echo -e "${NC}"
}

print_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
print_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
print_error() { echo -e "${RED}[ERROR]${NC} $*"; }

check_dependencies() {
    local missing=()
    command -v restic &> /dev/null || missing+=("restic")
    command -v rclone &> /dev/null || missing+=("rclone")
    [[ ${#missing[@]} -gt 0 ]] && print_error "Missing dependencies: ${missing[*]}" && exit 1
}

check_password_file() {
    [[ ! -f "${RESTIC_PASSWORD_FILE}" ]] && print_error "Password file not found: ${RESTIC_PASSWORD_FILE}" && exit 1
}

select_snapshot() {
    print_info "Fetching available snapshots..."
    echo ""
    
    local snapshots_json
    snapshots_json=$(restic snapshots --tag "projects" --json 2>/dev/null)
    
    if [[ -z "${snapshots_json}" ]] || [[ "${snapshots_json}" == "[]" ]]; then
        print_error "No snapshots found in repository"
        exit 1
    fi
    
    echo -e "${BOLD}Available Snapshots:${NC}"
    echo "------------------------------------------------------------"
    
    local i=1
    local snapshot_ids=()
    
    while IFS= read -r line; do
        local id time hostname
        id=$(echo "$line" | cut -d'|' -f1)
        time=$(echo "$line" | cut -d'|' -f2)
        hostname=$(echo "$line" | cut -d'|' -f3)
        
        snapshot_ids+=("$id")
        printf "  ${CYAN}%2d)${NC} ${BOLD}%s${NC} - %s (%s)\n" "$i" "${id:0:8}" "$time" "$hostname"
        ((i++))
    done < <(restic snapshots --tag "projects" --json 2>/dev/null | \
        python3 -c "import json, sys; data = json.load(sys.stdin); [print(f\"{s['short_id']}|{s['time'][:19].replace('T', ' ')}|{s['hostname']}\") for s in sorted(data, key=lambda x: x['time'], reverse=True)]" 2>/dev/null || \
        restic snapshots --tag "projects" 2>/dev/null | tail -n +3 | head -n -2 | while read -r id time1 time2 host tags paths size; do
            echo "${id}|${time1} ${time2}|${host}"
        done)
    
    echo "------------------------------------------------------------"
    echo ""
    
    if [[ ${#snapshot_ids[@]} -eq 0 ]]; then
        print_info "Using simple snapshot listing..."
        restic snapshots --tag "projects"
        echo ""
        read -rp "Enter snapshot ID to restore: " SELECTED_SNAPSHOT
        return
    fi
    
    echo -e "  ${CYAN} L)${NC} Latest snapshot"
    echo ""
    
    while true; do
        read -rp "Select snapshot number (or 'L' for latest, 'q' to quit): " choice
        
        [[ "${choice,,}" == "q" ]] && echo "Cancelled." && exit 0
        [[ "${choice,,}" == "l" ]] && SELECTED_SNAPSHOT="latest" && break
        
        if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#snapshot_ids[@]} ]]; then
            SELECTED_SNAPSHOT="${snapshot_ids[$((choice-1))]}"
            break
        fi
        
        print_warn "Invalid selection. Please try again."
    done
    
    print_info "Selected snapshot: ${SELECTED_SNAPSHOT}"
}

select_restore_target() {
    echo ""
    echo -e "${BOLD}Restore Options:${NC}"
    echo "------------------------------------------------------------"
    echo -e "  ${CYAN}1)${NC} Restore to original location (${PROJECTS_DIR})"
    echo -e "  ${CYAN}2)${NC} Restore to custom directory"
    echo -e "  ${CYAN}3)${NC} Restore specific file/folder only"
    echo "------------------------------------------------------------"
    echo ""
    
    while true; do
        read -rp "Select option (1-3, or 'q' to quit): " choice
        
        case "$choice" in
            1)
                RESTORE_TARGET="${PROJECTS_DIR}"
                RESTORE_MODE="full"
                print_warn "This will restore files to their original location!"
                read -rp "Are you sure? (yes/no): " confirm
                [[ "${confirm,,}" != "yes" ]] && echo "Cancelled." && exit 0
                break
                ;;
            2)
                read -rp "Enter target directory: " RESTORE_TARGET
                RESTORE_MODE="full"
                [[ -z "${RESTORE_TARGET}" ]] && print_warn "No directory specified." && continue
                break
                ;;
            3)
                RESTORE_MODE="partial"
                select_partial_restore
                break
                ;;
            q|Q)
                echo "Cancelled."
                exit 0
                ;;
            *)
                print_warn "Invalid selection. Please try again."
                ;;
        esac
    done
}

select_partial_restore() {
    echo ""
    print_info "Listing contents of snapshot ${SELECTED_SNAPSHOT}..."
    echo ""
    
    echo -e "${BOLD}Top-level directories in snapshot:${NC}"
    echo "------------------------------------------------------------"
    restic ls "${SELECTED_SNAPSHOT}" --tag "projects" 2>/dev/null | head -50
    echo "------------------------------------------------------------"
    echo ""
    
    read -rp "Enter path to restore (relative to snapshot root): " RESTORE_PATH
    [[ -z "${RESTORE_PATH}" ]] && print_error "No path specified." && exit 1
    
    read -rp "Enter target directory for restoration: " RESTORE_TARGET
    [[ -z "${RESTORE_TARGET}" ]] && RESTORE_TARGET="./restored" && print_info "Using default target: ${RESTORE_TARGET}"
}

perform_restore() {
    echo ""
    print_info "Starting restore..."
    print_info "  Snapshot: ${SELECTED_SNAPSHOT}"
    print_info "  Target: ${RESTORE_TARGET}"
    [[ "${RESTORE_MODE}" == "partial" ]] && print_info "  Path: ${RESTORE_PATH}"
    echo ""
    
    mkdir -p "${RESTORE_TARGET}"
    
    if [[ "${RESTORE_MODE}" == "full" ]]; then
        if restic restore "${SELECTED_SNAPSHOT}" --target "${RESTORE_TARGET}" --tag "projects"; then
            echo ""
            print_info "Restore completed successfully!"
            print_info "Files restored to: ${RESTORE_TARGET}"
        else
            print_error "Restore failed!"
            exit 1
        fi
    else
        if restic restore "${SELECTED_SNAPSHOT}" --target "${RESTORE_TARGET}" --include "${RESTORE_PATH}" --tag "projects"; then
            echo ""
            print_info "Restore completed successfully!"
            print_info "Files restored to: ${RESTORE_TARGET}"
        else
            print_error "Restore failed!"
            exit 1
        fi
    fi
}

show_help() {
    cat << EOF
Project Restore Helper - Interactive restoration from restic backups

Usage: $(basename "$0") [options]

Options:
    -h, --help              Show this help message
    -l, --list              List available snapshots
    -s, --snapshot <id>     Specify snapshot ID (skip selection)
    -t, --target <dir>      Specify target directory (skip selection)
    -p, --path <path>       Restore specific path only
    -b, --browse            Browse snapshot contents interactively

Examples:
    $(basename "$0")                           # Interactive mode
    $(basename "$0") --list                    # List snapshots
    $(basename "$0") -s latest -t ./restore    # Restore latest to ./restore
    $(basename "$0") -s abc123 -p /Projects/myapp -t ./myapp  # Restore specific folder
EOF
}

main() {
    SELECTED_SNAPSHOT=""
    RESTORE_TARGET=""
    RESTORE_PATH=""
    RESTORE_MODE="full"
    BROWSE_MODE=false
    LIST_ONLY=false
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help) show_help; exit 0 ;;
            -l|--list) LIST_ONLY=true; shift ;;
            -s|--snapshot) SELECTED_SNAPSHOT="$2"; shift 2 ;;
            -t|--target) RESTORE_TARGET="$2"; shift 2 ;;
            -p|--path) RESTORE_PATH="$2"; RESTORE_MODE="partial"; shift 2 ;;
            -b|--browse) BROWSE_MODE=true; shift ;;
            *) print_error "Unknown option: $1"; show_help; exit 1 ;;
        esac
    done
    
    check_dependencies
    check_password_file
    
    if [[ "${LIST_ONLY}" == true ]]; then
        restic snapshots --tag "projects"
        exit 0
    fi
    
    print_header
    print_info "Repository: ${RESTIC_REPOSITORY}"
    print_info "Source directory: ${PROJECTS_DIR}"
    echo ""
    
    [[ -z "${SELECTED_SNAPSHOT}" ]] && select_snapshot
    [[ -z "${RESTORE_TARGET}" ]] && select_restore_target
    
    perform_restore
}

main "$@"
