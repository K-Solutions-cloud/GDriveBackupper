#!/bin/bash
# ============================================================
# Project Backup Script
# Uses restic with rclone backend to backup projects to Google Drive
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

if [[ -f "${PROJECT_DIR}/config/backup.env" ]]; then
    source "${PROJECT_DIR}/config/backup.env"
else
    echo "ERROR: Configuration file not found: ${PROJECT_DIR}/config/backup.env"
    exit 1
fi

export RESTIC_REPOSITORY
export RESTIC_PASSWORD_FILE
export RESTIC_COMPRESSION="${RESTIC_COMPRESSION:-auto}"

EXCLUDE_FILE="${PROJECT_DIR}/config/exclude-patterns.txt"
mkdir -p "${LOG_DIR}"
LOG_FILE="${LOG_DIR}/project-backup.log"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    local level="$1"
    shift
    local message="$*"
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[${timestamp}] [${level}] ${message}" >> "${LOG_FILE}"
    
    case "${level}" in
        INFO) echo -e "${GREEN}[INFO]${NC} ${message}" ;;
        WARN) echo -e "${YELLOW}[WARN]${NC} ${message}" ;;
        ERROR) echo -e "${RED}[ERROR]${NC} ${message}" ;;
        DEBUG) [[ "${VERBOSE:-false}" == "true" ]] && echo -e "${BLUE}[DEBUG]${NC} ${message}" ;;
    esac
}

log_info() { log "INFO" "$@"; }
log_warn() { log "WARN" "$@"; }
log_error() { log "ERROR" "$@"; }
log_debug() { log "DEBUG" "$@"; }

check_dependencies() {
    local missing=()
    command -v restic &> /dev/null || missing+=("restic")
    command -v rclone &> /dev/null || missing+=("rclone")
    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "Missing dependencies: ${missing[*]}"
        exit 1
    fi
}

check_password_file() {
    if [[ ! -f "${RESTIC_PASSWORD_FILE}" ]]; then
        log_error "Password file not found: ${RESTIC_PASSWORD_FILE}"
        exit 1
    fi
    local perms=$(stat -c %a "${RESTIC_PASSWORD_FILE}")
    if [[ "${perms}" != "600" ]]; then
        log_warn "Password file permissions are ${perms}, should be 600"
        chmod 600 "${RESTIC_PASSWORD_FILE}"
    fi
}

check_exclude_file() {
    [[ ! -f "${EXCLUDE_FILE}" ]] && log_error "Exclusion patterns file not found: ${EXCLUDE_FILE}" && exit 1
}

check_source_directories() {
    local has_valid_dir=false
    [[ -d "${PROJECTS_DIR}" ]] && has_valid_dir=true || log_warn "Projects directory not found: ${PROJECTS_DIR}"
    [[ -n "${PROJECTS_DIR_SECONDARY:-}" ]] && [[ -d "${PROJECTS_DIR_SECONDARY}" ]] && has_valid_dir=true
    [[ "${has_valid_dir}" != "true" ]] && log_error "No valid projects directories found!" && exit 1
}

get_backup_dirs() {
    local dirs=()
    [[ -d "${PROJECTS_DIR}" ]] && dirs+=("${PROJECTS_DIR}")
    [[ -n "${PROJECTS_DIR_SECONDARY:-}" ]] && [[ -d "${PROJECTS_DIR_SECONDARY}" ]] && dirs+=("${PROJECTS_DIR_SECONDARY}")
    echo "${dirs[@]}"
}

init_repository() {
    log_info "Checking if repository is initialized..."
    if restic cat config &> /dev/null; then
        log_debug "Repository already initialized"
    else
        log_info "Initializing restic repository..."
        restic init --repository-version 2 || { log_error "Failed to initialize repository"; exit 1; }
        log_info "Repository initialized successfully"
    fi
}

rotate_log() {
    if [[ -f "${LOG_FILE}" ]]; then
        local size=$(stat -c %s "${LOG_FILE}" 2>/dev/null || echo 0)
        if [[ ${size} -gt ${MAX_LOG_SIZE:-10485760} ]]; then
            local backup="${LOG_FILE}.$(date '+%Y%m%d_%H%M%S')"
            mv "${LOG_FILE}" "${backup}"
            gzip "${backup}" 2>/dev/null || true
            ls -t "${LOG_FILE}".*.gz 2>/dev/null | tail -n +6 | xargs -r rm -f
        fi
    fi
}

cmd_backup() {
    log_info "Starting project backup..."
    log_info "Repository: ${RESTIC_REPOSITORY}"
    
    check_dependencies
    check_password_file
    check_exclude_file
    check_source_directories
    init_repository
    rotate_log
    
    local backup_dirs=($(get_backup_dirs))
    log_info "Source directories:"
    for dir in "${backup_dirs[@]}"; do log_info "  - ${dir}"; done
    
    local start_time=$(date +%s)
    log_info "Running backup with exclusion patterns..."
    log_info "Compression mode: ${RESTIC_COMPRESSION}"
    
    if restic backup --exclude-file="${EXCLUDE_FILE}" --compression "${RESTIC_COMPRESSION}" --verbose --tag "projects" --tag "$(hostname)" "${backup_dirs[@]}" 2>&1 | tee -a "${LOG_FILE}"; then
        local duration=$(($(date +%s) - start_time))
        log_info "Backup completed successfully in ${duration} seconds"
        [[ "${AUTO_PRUNE:-true}" == "true" ]] && log_info "Running automatic prune..." && cmd_prune
        return 0
    else
        log_error "Backup failed!"
        return 1
    fi
}

cmd_snapshots() {
    log_info "Listing snapshots..."
    check_dependencies
    check_password_file
    restic snapshots --tag "projects"
}

cmd_restore() {
    local snapshot_id="${1:-}"
    local target="${2:-}"
    [[ -z "${snapshot_id}" ]] && log_error "Usage: $0 restore <snapshot-id> <target-directory>" && exit 1
    [[ -z "${target}" ]] && log_error "Please specify a target directory for restoration" && exit 1
    check_dependencies
    check_password_file
    log_info "Restoring snapshot ${snapshot_id} to ${target}..."
    mkdir -p "${target}"
    restic restore "${snapshot_id}" --target "${target}" && log_info "Restore completed successfully" || { log_error "Restore failed!"; exit 1; }
}

cmd_check() {
    log_info "Checking repository integrity..."
    check_dependencies
    check_password_file
    restic check --read-data-subset=5% && log_info "Repository integrity check passed" || { log_error "Repository integrity check failed!"; exit 1; }
}

cmd_prune() {
    log_info "Pruning old snapshots..."
    log_info "Retention policy: keep-last=${RESTIC_KEEP_LAST:-10}, keep-daily=${RESTIC_KEEP_DAILY:-7}, keep-weekly=${RESTIC_KEEP_WEEKLY:-4}, keep-monthly=${RESTIC_KEEP_MONTHLY:-6}"
    check_dependencies
    check_password_file
    restic forget --keep-last "${RESTIC_KEEP_LAST:-10}" --keep-daily "${RESTIC_KEEP_DAILY:-7}" --keep-weekly "${RESTIC_KEEP_WEEKLY:-4}" --keep-monthly "${RESTIC_KEEP_MONTHLY:-6}" --prune --tag "projects" && log_info "Prune completed successfully" || { log_error "Prune failed!"; exit 1; }
}

cmd_stats() {
    log_info "Repository statistics..."
    check_dependencies
    check_password_file
    echo ""
    echo "=== Repository Stats ==="
    restic stats
    echo ""
    echo "=== Latest Snapshot Stats ==="
    restic stats latest --tag "projects" 2>/dev/null || echo "No snapshots found with tag 'projects'"
    echo ""
    echo "=== Snapshot Count ==="
    local count=$(restic snapshots --tag "projects" --json 2>/dev/null | grep -c '"id"' || echo "0")
    echo "Total snapshots: ${count}"
}

cmd_diff() {
    local snapshot1="${1:-}"
    local snapshot2="${2:-}"
    [[ -z "${snapshot1}" ]] || [[ -z "${snapshot2}" ]] && log_error "Usage: $0 diff <snapshot-id-1> <snapshot-id-2>" && exit 1
    check_dependencies
    check_password_file
    log_info "Comparing snapshots ${snapshot1} and ${snapshot2}..."
    restic diff "${snapshot1}" "${snapshot2}"
}

cmd_find() {
    local pattern="${1:-}"
    [[ -z "${pattern}" ]] && log_error "Usage: $0 find <pattern>" && exit 1
    check_dependencies
    check_password_file
    log_info "Searching for '${pattern}' in snapshots..."
    restic find "${pattern}" --tag "projects"
}

cmd_unlock() {
    log_info "Removing stale locks from repository..."
    check_dependencies
    check_password_file
    restic unlock && log_info "Repository unlocked successfully" || { log_error "Failed to unlock repository"; exit 1; }
}

show_help() {
    cat << EOF
Project Backup Script - Backup projects to Google Drive using restic

Usage: $(basename "$0") <command> [options]

Commands:
    backup              Run a backup of the projects directory
    snapshots           List all available snapshots
    restore <id> <dir>  Restore a snapshot to a directory
    check               Verify repository integrity
    prune               Clean up old snapshots based on retention policy
    stats               Show repository statistics
    diff <id1> <id2>    Show differences between two snapshots
    find <pattern>      Search for files in snapshots
    unlock              Remove stale locks from repository
    help                Show this help message

Configuration:
    Config file:        ${PROJECT_DIR}/config/backup.env
    Exclusion patterns: ${EXCLUDE_FILE}
    Log file:           ${LOG_FILE}
    Repository:         ${RESTIC_REPOSITORY}

Examples:
    $(basename "$0") backup                    # Run a backup
    $(basename "$0") snapshots                 # List snapshots
    $(basename "$0") restore latest ./restore  # Restore latest snapshot
    $(basename "$0") stats                     # Show statistics
    $(basename "$0") find "*.py"               # Find Python files
EOF
}

main() {
    local command="${1:-backup}"
    shift || true
    
    case "${command}" in
        backup) cmd_backup "$@" ;;
        snapshots|list) cmd_snapshots "$@" ;;
        restore) cmd_restore "$@" ;;
        check|verify) cmd_check "$@" ;;
        prune|forget) cmd_prune "$@" ;;
        stats|status) cmd_stats "$@" ;;
        diff) cmd_diff "$@" ;;
        find|search) cmd_find "$@" ;;
        unlock) cmd_unlock "$@" ;;
        help|--help|-h) show_help ;;
        *) log_error "Unknown command: ${command}"; show_help; exit 1 ;;
    esac
}

main "$@"
